--Multiple orders of magnitude win

--Single hub with single star, non key-foreign key join with the hub
--|V1|=1796
CREATE VIEW V1
WITH SCHEMABINDING 
AS
SELECT ORDERS.O_ORDERKEY, PART.P_PARTKEY
FROM dbo.ORDERS, dbo.PART
WHERE PART.P_RETAILPRICE=ORDERS.O_TOTALPRICE AND
PART.P_MFGR='Manufacturer#1'        

CREATE UNIQUE CLUSTERED INDEX V1_INDEX ON dbo.V1 (O_ORDERKEY, P_PARTKEY);

--Single hub with two stars, key-foreign key join with the hub and one star, key-foreign key join between the stars 
--|V2|=504840
CREATE VIEW V2 
WITH SCHEMABINDING 
AS
SELECT CUSTOMER.C_CUSTKEY, SUPPLIER.S_SUPPKEY, NATION.N_NATIONKEY
FROM dbo.NATION, dbo.CUSTOMER, dbo.SUPPLIER
WHERE NATION.N_NATIONKEY = CUSTOMER.C_NATIONKEY AND
NATION.N_NATIONKEY = SUPPLIER.S_NATIONKEY AND
NATION.N_NAME='ALGERIA' AND
CUSTOMER.C_MKTSEGMENT='AUTOMOBILE' AND
CUSTOMER.C_PHONE LIKE '10-%';

CREATE UNIQUE CLUSTERED INDEX V2_INDEX ON dbo.V2 (C_CUSTKEY, S_SUPPKEY, N_NATIONKEY);

--Actual: 2520
--SQL estimate: 168041

SELECT DISTINCT PART.P_PARTKEY, SUPPLIER.S_SUPPKEY, NATION.N_NATIONKEY
FROM dbo.ORDERS, dbo.PART, dbo.CUSTOMER, dbo.SUPPLIER, dbo.NATION
WHERE ORDERS.O_CUSTKEY=CUSTOMER.C_CUSTKEY AND 
PART.P_RETAILPRICE=ORDERS.O_TOTALPRICE AND
PART.P_MFGR='Manufacturer#1' AND
NATION.N_NATIONKEY = CUSTOMER.C_NATIONKEY AND
NATION.N_NATIONKEY = SUPPLIER.S_NATIONKEY AND
NATION.N_NAME='ALGERIA' AND
CUSTOMER.C_MKTSEGMENT='AUTOMOBILE' AND
CUSTOMER.C_PHONE LIKE '10-%';