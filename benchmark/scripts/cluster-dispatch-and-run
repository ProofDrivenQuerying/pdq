#!/bin/bash

#
# ARG1: location of the test case to run
#

source cluster-settings

rcp="scp -C"

typeset -i i=0

# Dispatching case directories files to all instances
for dir in `find $1 -type d -links 2`
do hostname="${prefix}${instances[${i}]}${suffix}" 
   echo "Deploying case ${dir} on ${hostname}..." 
   ssh ${keypair} ${hostname} rm -Rf ${testdir}/${dir} 
   ssh ${keypair} ${hostname} mkdir -p ${testdir}/${dir} 
   ${rcp} ${keypair} -r ${dir}/* ${hostname}:${testdir}/${dir} 
   i=(i+1)%${#instances[@]}
done

i=0
# Launching experiments
for instance in ${instances[@]}
do hostname="${prefix}${instances[${i}]}${suffix}" 
   echo "Launching experiments on ${hostname}..." 
   ssh ${keypair} ${hostname} nohup ${deploydir}/recursive-run planner ${deploydir} ${testdir} &
   i+=1
done
